<div class="page">
  <h1>{{ title }}</h1>

  <div class="row">
    <div class="col-md-3">
      <ul ngbNav #nav="ngbNav" activeId="migration" class="nav-pills mb-5" orientation="vertical">
        <li ngbNavItem="migration">
          <a ngbNavLink routerLink="/equipment/migration-tool">Migration</a>
        </li>

        <li ngbNavItem="review">
          <a ngbNavLink routerLink="/equipment/migration-review">Review</a>
        </li>
      </ul>

      <ul ngbNav #nav="ngbNav" [(activeId)]="activeType" class="nav-pills" orientation="vertical">
        <li ngbNavItem="camera">
          <a ngbNavLink routerLink="../camera">Cameras</a>
          <span class="counter">{{ nonMigratedCamerasCount$ | async }}</span>
        </li>

        <li ngbNavItem="telescope" [disabled]="true">
          <a ngbNavLink routerLink="../telescope">Telescopes</a>
        </li>

        <li ngbNavItem="mount" [disabled]="true">
          <a ngbNavLink routerLink="../mount">Mounts</a>
        </li>

        <li ngbNavItem="filter" [disabled]="true">
          <a ngbNavLink routerLink="../filter">Filters</a>
        </li>

        <li ngbNavItem="accessory" [disabled]="true">
          <a ngbNavLink routerLink="../accessory">Accessories</a>
        </li>

        <li ngbNavItem="software" [disabled]="true">
          <a ngbNavLink routerLink="../software">Software</a>
        </li>
      </ul>
    </div>

    <div class="col-md-9">
      <ng-container *ngIf="pendingReview$ | async as pendingReview; else loading">
        <div class="alert alert-info" *ngIf="pendingReview.length > 0; else randomNonMigrated">
          <h4>Hold your horses!</h4>
          <p>
            You cannot migrate items while the review queue is not empty. This is to prevent creating multiple items
            representing the same object.
          </p>
          <br />
          <a routerLink="../../migration-review" class="btn btn-primary">Go to the review queue</a>
        </div>
      </ng-container>
    </div>
    <!-- main col -->
  </div>
  <!-- main row -->
</div>
<!-- page -->

<ng-template #loading>
  <astrobin-loading-indicator></astrobin-loading-indicator>
</ng-template>

<ng-template #allDone>
  <div class="alert alert-success">
    <h4>Hooray ðŸŽ‰</h4>
    <p>There are no more items of this type to migrate, we did it! This was awesome, thank you!</p>
  </div>
</ng-template>

<ng-template #equipmentItemOptionTemplate let-object="item">
  <astrobin-equipment-item-summary [item]="object.item"></astrobin-equipment-item-summary>
</ng-template>

<ng-template #randomNonMigrated>
  <ng-container *ngIf="randomNonMigrated$ | async as objects; else loading">
    <ng-container *ngIf="objects.length > 0; else allDone">
      <ng-container *ngIf="objects[0] as object">
        <div class="card box-shadow" [class.disabled]="migration.inProgress || creation.inProgress">
          <div class="card-header">
            What would you like to do with the following legacy item?
          </div>

          <div class="card-body">
            <p>
              Brand/Make: <strong>{{ object.make || "(no brand)" }}</strong>
            </p>
            <p>
              Name/Model: <strong>{{ object.name || "(no name)" }}</strong>
            </p>

            <ng-container *ngFor="let key of gearService.getProperAttributes(object)">
              <p>
                {{ key | camelCaseToSentenceCase }}: <strong>{{ object[key] !== null ? object[key] : "n/a" }}</strong>
              </p>
            </ng-container>

            <div
              class="alert alert-info"
              *ngIf="object.migrationFlagReviewerDecision && object.migrationFlagReviewerDecision !== 'ACCEPTED'"
            >
              <div>
                <strong>Please note:</strong> this legacy item has a previous migration proposal that was rejected.
              </div>
              <dl class="mt-3">
                <dt>Reason</dt>
                <dd>{{ object.migrationFlagReviewerDecision }}</dd>

                <dt>Comment</dt>
                <dd>{{ object.migrationFlagReviewerRejectionComment || "n/a" }}</dd>
              </dl>
            </div>
          </div>

          <div class="card-footer">
            <button
              class="btn btn-sm-block btn-secondary"
              [disabled]="migration.inProgress || creation.inProgress"
              [class.loading]="loadingService.isLoading()"
              (click)="skip(object)"
            >
              Skip for now
            </button>

            <div class="d-inline-block" ngbDropdown>
              <button
                ngbDropdownToggle
                id="mark-as-dropdown-button"
                class="btn btn-sm-block btn-secondary"
                [disabled]="migration.inProgress || creation.inProgress"
                [class.loading]="loadingService.isLoading()"
              >
                Mark as...
              </button>

              <div aria-labelledby="mark-as-dropdown-button" ngbDropdownMenu>
                <a href="" class="dropdown-item" (click)="markAsWrongType($event, object)">
                  Wrong type
                </a>

                <a href="" class="dropdown-item" (click)="markAsMultiple($event, object)">
                  Multiple items
                </a>

                <a href="" class="dropdown-item" (click)="markAsDIY($event, object)">
                  DIY
                </a>

                <a href="" class="dropdown-item" (click)="markAsNotEnoughInfo($event, object)">
                  Not enough info
                </a>
              </div>
            </div>

            <button
              class="btn btn-sm-block btn-primary"
              [disabled]="migration.inProgress || creation.inProgress"
              [class.loading]="loadingService.isLoading()"
              (click)="beginMigration(object)"
            >
              Migrate...
            </button>
          </div>
        </div>

        <ng-container *ngIf="migration.inProgress">
          <div class="mt-4 mb-4 text-center">
            <fa-icon icon="arrow-down"></fa-icon>
          </div>

          <div class="card" [class.disabled]="creation.inProgress" id="select-item-to-migrate-to">
            <div class="card-header">
              Select equipment object to migrate "<strong>{{ object.make || "(no brand)" }}</strong>
              {{ object.name || "(no name)" }}" to, or create a new one
            </div>

            <div class="card-body">
              <form [formGroup]="migration.form">
                <formly-form
                  [fields]="migration.fields"
                  [form]="migration.form"
                  [model]="migration.model"
                ></formly-form>
              </form>
            </div>

            <div class="card-footer">
              <button
                class="btn btn-sm-block btn-secondary"
                [disabled]="creation.inProgress"
                [class.loading]="loadingService.isLoading()"
                (click)="cancelMigration()"
              >
                Cancel
              </button>

              <button
                class="btn btn-sm-block btn-primary"
                [disabled]="!selectedMigrationItem || creation.inProgress"
                [class.loading]="loadingService.isLoading()"
                (click)="confirmMigration(object)"
              >
                Confirm migration
              </button>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="creation.inProgress">
          <div class="mt-4 mb-4 text-center">
            <fa-icon icon="arrow-down"></fa-icon>
          </div>

          <div class="mt-4 mb-4">
            <div class="card" [class.disabled-with-backdrop]="subCreation.inProgress" id="create-new-item">
              <div class="backdrop"></div>

              <div class="card-header">
                Create a new item
              </div>

              <div class="card-body">
                <astrobin-camera-editor
                  *ngIf="activeType === 'camera'"
                  [form]="creation.form"
                  [model]="creation.model"
                  [name]="migration.q"
                  (subCreationInProgress)="subCreation.inProgress = $event"
                  (suggestionSelected)="itemCreated($event)"
                ></astrobin-camera-editor>
              </div>

              <div class="card-footer">
                <button
                  class="btn btn-sm-block btn-secondary"
                  [class.loading]="loadingService.isLoading()"
                  (click)="restItemCreation()"
                >
                  Cancel
                </button>

                <button
                  class="btn btn-sm-block btn-primary"
                  [disabled]="!creation.form.valid"
                  [class.loading]="loadingService.isLoading()"
                  (click)="createItem()"
                >
                  Create item
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>
