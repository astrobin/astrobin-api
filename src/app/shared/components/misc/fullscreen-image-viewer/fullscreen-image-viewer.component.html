<ng-container *ngIf="(show$ | async) === true">
  <ng-container
    *ngIf="{
      hd: hdThumbnail$ | async,
      real: realThumbnail$ | async
    } as thumbnails"
  >
    <ng-container
      *ngIf="isTouchDevice || !isLargeEnough"
      [ngTemplateOutletContext]="{
        url: thumbnails.real ? thumbnails.real : thumbnails.hd
      }"
      [ngTemplateOutlet]="noZoom"
    >
    </ng-container>

    <ng-container *ngIf="!isTouchDevice && isLargeEnough">
      <ng-container
        *ngIf="thumbnails.hd && thumbnails.real; else hdOnly"
        [ngTemplateOutletContext]="{ hd: thumbnails.hd, real: thumbnails.real }"
        [ngTemplateOutlet]="imageZoom"
      >
      </ng-container>

      <ng-template #hdOnly>
        <ng-container
          *ngIf="thumbnails.hd; else hdImageLoadingTmpl"
          [ngTemplateOutletContext]="{ url: thumbnails.hd }"
          [ngTemplateOutlet]="noZoom"
        >
        </ng-container>
      </ng-template>
    </ng-container>
  </ng-container>

  <div
    *ngIf="!isTouchDevice && isLargeEnough"
    [class.lens-enabled]="enableLens"
    class="enable-lens-toggle"
  >
    <fa-icon
      icon="magnifying-glass"
      (click)="toggleEnableLens()"
      [ngbTooltip]="enableLens ? ('Disable lens' | translate) : ('Enable lens' | translate)"
      container="body"
    ></fa-icon>
  </div>

  <div (click)="hide($event)" class="close">
    <fa-icon icon="times"></fa-icon>
    <span class="esc">ESC</span>
  </div>
</ng-container>

<ng-template #imageZoom let-hd="hd" let-real="real">
  <div class="position-relative">
    <lib-ngx-image-zoom
      #ngxImageZoom
      (zoomPosition)="setZoomPosition($event)"
      (zoomScroll)="setZoomScroll($event)"
      (imagesLoaded)="onImagesLoaded($event)"
      [circularLens]="true"
      [enableLens]="enableLens"
      [enableScrollZoom]="true"
      [fullImage]="real"
      [lensHeight]="zoomLensSize"
      [lensWidth]="zoomLensSize"
      [maxZoomRatio]="8"
      [minZoomRatio]="0.1"
      [thumbImage]="hd"
      zoomMode="toggle-click"
      class="image-zoom"
      [class.lens-enabled]="enableLens"
    >
    </lib-ngx-image-zoom>

    <div
      *ngIf="showZoomIndicator"
      class="image-zoom-indicator"
      [ngStyle]="getZoomIndicatorStyle()"
    >
      {{ getZoomScroll() | number: "1.2-2" }}x
    </div>

    <div *ngIf="!showZoomIndicator && !isTouchDevice && isLargeEnough" class="instruction-container">
      <div class="instructions">
        <fa-icon icon="mouse-pointer"></fa-icon>
        <span>{{ "Click to zoom, scroll to magnify." | translate }}</span>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #noZoom let-url="url">
  <div class="no-zoom">
    <img [src]="url" alt="" />
    <ng-container [ngTemplateOutlet]="realThumbnailLoadingTmpl"></ng-container>
    <ng-container [ngTemplateOutlet]="realImageLoadingTmpl"></ng-container>
  </div>
</ng-template>

<ng-template #hdImageLoadingTmpl>
  <div class="loading-indicator-container">
    <astrobin-loading-indicator [progress]="hdImageLoadingProgress$ | async"></astrobin-loading-indicator>
  </div>
</ng-template>

<ng-template #realThumbnailLoadingTmpl>
  <div *ngIf="realThumbnailLoading" class="loading-indicator-container has-message">
    <astrobin-loading-indicator
      [message]="'Downloading high resolution image' | translate"
    ></astrobin-loading-indicator>
  </div>
</ng-template>

<ng-template #realImageLoadingTmpl>
  <div *ngIf="realImageLoadingProgress$ | async as progress" class="loading-indicator-container has-message">
    <astrobin-loading-indicator
      *ngIf="progress && progress < 100"
      [message]="'Downloading high resolution image' | translate"
      [progress]="progress"
    ></astrobin-loading-indicator>
  </div>
</ng-template>
