<div class="image-viewer-overlay">
  <ng-container *ngIf="!!image; else loadingTemplate">
    <ng-container [ngTemplateOutlet]="imageAreaTemplate"></ng-container>

    <div class="data-area-container">
      <ng-container [ngTemplateOutlet]="dataAreaTemplate"></ng-container>
      <ng-container [ngTemplateOutlet]="buttonsAreaTemplate"></ng-container>
    </div> <!-- data-area-container -->
  </ng-container>
</div>

<ng-template #loadingTemplate>
  <astrobin-loading-indicator></astrobin-loading-indicator>
</ng-template>

<ng-template #imageAreaTemplate>
  <div
    #imageArea
    class="image-area"
  >
    <button class="close-button" (click)="close()">
      <fa-icon
        [ngbTooltip]="'Close' | translate"
        icon="times-circle"
      ></fa-icon>
    </button>

    <div class="additional-buttons">
      <button
        *ngIf="revision?.solution && (revision?.solution.skyplotZoom1 || revision?.solution.pixinsightFindingChart)"
        (click)="openSkyplot($event)"
        class="skyplot-button"
      >
        <fa-icon
          [ngbTooltip]="'View sky map' | translate"
          icon="map"
        ></fa-icon>
      </button>

      <button *ngIf="!revision?.videoFile" class="histogram-button" (click)="openHistogram($event)">
        <fa-icon
          [ngbTooltip]="'View histogram' | translate"
          icon="chart-simple"
        ></fa-icon>
      </button>

      <button *ngIf="!revision?.videoFile" class="fullscreen-button" (click)="openFullscreen($event)">
        <fa-icon
          [ngbTooltip]="'View fullscreen' | translate"
          icon="expand"
        ></fa-icon>
      </button>
    </div>

    <button
      *ngIf="currentIndex > 0"
      (click)="onPreviousClicked()"
      class="previous-button"
    >
      <fa-icon icon="chevron-circle-left"></fa-icon>
    </button>

    <astrobin-fullscreen-image-viewer
      [id]="image.pk"
      [revision]="revisionLabel"
    ></astrobin-fullscreen-image-viewer>

    <astrobin-image
      (imageClick)="openFullscreen($event)"
      (loaded)="onImageLoaded()"
      [alias]="alias"
      [image]="image"
      [revision]="revisionLabel"
    ></astrobin-image>

    <img
      *ngIf="mouseHoverImage && imageLoaded"
      (click)="openFullscreen($event)"
      alt=""
      class="mouse-hover"
      src="{{ mouseHoverImage }}"
    />

    <div
      *ngIf="inlineSvg && imageLoaded"
      (click)="openFullscreen($event)"
      class="mouse-hover-container d-flex justify-content-center position-absolute"
    >
      <div
        [innerHTML]="inlineSvg"
        [id]="'mouse-hover-svg-' + image.pk"
        class="mouse-hover w-100 position-relative"
      ></div>
    </div>

    <astrobin-image-viewer-revisions
      [image]="image"
      (revisionSelected)="onRevisionSelected($event)"
      [class.show]="showRevisions"
    ></astrobin-image-viewer-revisions>

    <button
      *ngIf="currentIndex < navigationContext?.length - 1"
      (click)="onNextClicked()"
      class="next-button"
    >
      <fa-icon icon="chevron-circle-right"></fa-icon>
    </button>

    {{showRevisions}}

    <button
      *ngIf="image.revisions?.length"
      (click)="showRevisions = !showRevisions"
      class="revisions-mobile-button"
    >
      <fa-icon icon="ellipsis"></fa-icon>
    </button>
  </div>
</ng-template>

<ng-template #descriptionTemplate>
  <div *ngIf="image.descriptionBbcode" class="metadata-section">
    <div class="metadata-item description" [innerHTML]="image.descriptionBbcode | BBCodeToHtml"></div>
  </div>

  <div *ngIf="image.description && !image.descriptionBbcode" class="metadata-section">
    <div class="metadata-item description" [innerHTML]="image.description"></div>
  </div>
</ng-template>

<ng-template #dataAreaTemplate>
  <div class="data-area">
    <astrobin-image-viewer-title
      [image]="image"
    ></astrobin-image-viewer-title>

    <astrobin-image-viewer-photographers
      [image]="image"
      [userContentType]="userContentType"
    ></astrobin-image-viewer-photographers>

    <astrobin-image-viewer-data-source
      [image]="image"
    ></astrobin-image-viewer-data-source>

    <astrobin-image-viewer-acquisition
      *ngIf="image.deepSkyAcquisitions?.length || image.solarSystemAcquisitions?.length"
      [image]="image"
    ></astrobin-image-viewer-acquisition>

    <astrobin-image-viewer-astrometry
      *ngIf="revision?.solution?.ra !== null && revision?.solution?.dec !== null"
      [image]="image"
      [revisionLabel]="revisionLabel"
    ></astrobin-image-viewer-astrometry>

    <astrobin-image-viewer-equipment
      *ngIf="imageService.hasEquipment(image)"
      [image]="image"
    ></astrobin-image-viewer-equipment>

    <ng-container [ngTemplateOutlet]="descriptionTemplate"></ng-container>
  </div> <!-- data-area -->
</ng-template>

<ng-template #buttonsAreaTemplate>
  <div class="buttons-area">
    <ng-container *ngIf="currentUserWrapper$ | async as currentUserWrapper">
      <div *ngIf="currentUserWrapper.user?.id !== image.user" class="like">
        <astrobin-toggle-property
          [contentType]="imageContentType.id"
          [objectId]="image.pk"
          [userId]="currentUserWrapper.user?.id"
          [showLabel]="false"
          btnClass="btn btn-link link-secondary"
          propertyType="like"
        ></astrobin-toggle-property>
        <span class="count">{{ image.likeCount }}</span>
      </div>

      <div class="bookmark">
        <astrobin-toggle-property
          [contentType]="imageContentType.id"
          [objectId]="image.pk"
          [userId]="currentUserWrapper.user?.id"
          [showLabel]="false"
          btnClass="btn btn-link link-secondary"
          propertyType="bookmark"
        ></astrobin-toggle-property>
        <span class="count">{{ image.bookmarkCount }}</span>
      </div>

      <div class="comment">
        <button
          (click)="openCommentsModal($event)"
          class="btn btn-link link-secondary"
        >
          <fa-icon icon="comments"></fa-icon>
        </button>
        <span class="count">
              <astrobin-nested-comments-count
                [contentType]="imageContentType"
                [objectId]="image.pk"
              ></astrobin-nested-comments-count>
            </span>
      </div>
    </ng-container>
  </div> <!-- buttons-area -->
</ng-template>

<ng-template #histogramModalTemplate>
  <div class="modal-body">
    <img *ngIf="!loadingHistogram; else loadingTemplate" [src]="histogram" alt="" />
  </div>
</ng-template>

<ng-template #skyplotModalTemplate>
  <div class="modal-body">
    <img
      [src]="revision?.solution?.pixinsightFindingChart || revision?.solution?.skyplotZoom1"
      class="w-100"
      alt=""
    />
  </div>
</ng-template>
